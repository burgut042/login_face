================================================================================
                    LOGIN AUTHENTICATION API - TO'LIQ QOLLANMA
================================================================================

ğŸ“… Yaratilgan: 2025-12-19
ğŸ¯ Maqsad: face_login_auth va passport_login_auth funksiyalarini tushuntirish

Bu hujjat ikki xil login usulini batafsil tushuntiradi:
1. FACE LOGIN AUTH - Yuz tanish orqali login
2. PASSPORT LOGIN AUTH - Passport ma'lumotlari orqali login


================================================================================
                    1. FACE_LOGIN_AUTH - Yuz orqali login
================================================================================

### API ENDPOINT:
    POST /api/face-login-auth/

### MAQSAD:
    Face recognition orqali tizimga kirish (tanilgan shaxsni loginlash)

### ISHLASH KETMA-KETLIGI:
    1. Frontend detect_face API'ni chaqiradi (yuzni taniydi)
    2. detect_face person_id qaytaradi
    3. Frontend face_login_auth'ga person_id yuboradi
    4. Backend shaxsni loginlaydi va session yaratadi


================================================================================
                    FACE_LOGIN_AUTH - INPUT (QABUL QILADI)
================================================================================

### HTTP METOD:
    POST

### CONTENT-TYPE:
    application/json

### REQUEST BODY (JSON):

{
    "person_id": 123,                          // MAJBURIY - Person ID (detect_face'dan keladi)
    "image": "data:image/jpeg;base64,/9j/...", // IXTIYORIY - Login vaqtidagi rasm (base64)
    "confidence": 95.67                        // IXTIYORIY - Face recognition ishonch darajasi (%)
}

### MAYDONLAR TUSHUNCHASI:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Maydon nomi     â”‚ Majburiy â”‚ Tavsif                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ person_id       â”‚ âœ… HA    â”‚ Person modelidagi ID (detect_face'dan keladi)  â”‚
â”‚ image           â”‚ âŒ YO'Q  â”‚ Login vaqtidagi rasm (LoginLog'ga saqlash)     â”‚
â”‚ confidence      â”‚ âŒ YO'Q  â”‚ Face recognition ishonch darajasi (0-100)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
                    FACE_LOGIN_AUTH - DATABASE AMALLAR
================================================================================

### 1. PERSON TOPISH:

    SELECT * FROM emotion_app_person WHERE id = {person_id}

    Natija:
    - âœ… Topildi   â†’ Davom etadi
    - âŒ Topilmadi â†’ ERROR 404 qaytaradi

### 2. DJANGO USER YARATISH/YANGILASH:

    USERNAME = f"person_{person_id}"  # Masalan: person_123

    # User topish yoki yaratish
    SELECT * FROM auth_user WHERE username = 'person_123'

    Agar topilmasa:
        INSERT INTO auth_user (
            username,
            first_name,
            last_name,
            is_staff,
            is_superuser,
            is_active
        ) VALUES (
            'person_123',
            '{person.first_name}',
            '{person.last_name}',
            TRUE,
            TRUE,
            TRUE
        )

    Agar topilsa:
        UPDATE auth_user
        SET is_staff = TRUE,
            is_superuser = TRUE,
            is_active = TRUE
        WHERE username = 'person_123'

### 3. SESSION YARATISH (LOGIN):

    Django'ning login() funksiyasi:
    - User'ni session'ga saqlaydi
    - Cookie'da session_id yaratadi
    - request.user ga tayinlaydi

### 4. LOGIN LOG YARATISH:

    INSERT INTO emotion_app_loginlog (
        person_id,
        login_method,
        login_time,
        ip_address,
        confidence,
        success,
        login_photo        -- Agar image yuborilgan bo'lsa
    ) VALUES (
        {person_id},
        'face',
        NOW(),
        '{ip_address}',
        {confidence},
        TRUE,
        '{photo.jpg}'      -- Rasm base64'dan decode qilib saqlanadi
    )


================================================================================
                    FACE_LOGIN_AUTH - OUTPUT (QAYTARADI)
================================================================================

### MUVAFFAQIYATLI (SUCCESS):

HTTP Status: 200 OK

{
    "success": true,
    "message": "Testbek Testov tizimga kirdi",
    "redirect_url": "/dashboard/",
    "user": {
        "id": 456,                              // Django User ID
        "username": "person_123",               // Username
        "full_name": "Testbek Testov",          // To'liq ism
        "is_staff": true,                       // Admin panel kirish huquqi
        "is_superuser": true                    // Superuser huquqi
    }
}

### XATOLIK - Person topilmadi:

HTTP Status: 404 Not Found

{
    "success": false,
    "error": "Shaxs topilmadi"
}

### XATOLIK - person_id yo'q:

HTTP Status: 400 Bad Request

{
    "success": false,
    "error": "person_id kerak"
}

### XATOLIK - Server ichki xato:

HTTP Status: 500 Internal Server Error

{
    "success": false,
    "error": "Login jarayonida xatolik",
    "message": "Login jarayonida xatolik"
}


================================================================================
                    FACE_LOGIN_AUTH - MISOL (TO'LIQ)
================================================================================

### 1. FRONTENDDAN REQUEST:

POST http://localhost:8000/api/face-login-auth/
Content-Type: application/json

{
    "person_id": 123,
    "image": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEASABIAAD...",
    "confidence": 95.67
}

### 2. BACKEND JARAYONI:

Step 1: Person topish
    â†’ SELECT * FROM emotion_app_person WHERE id = 123
    â†’ Person: ID=123, Ism=Testbek, Familiya=Testov

Step 2: Django User yaratish
    â†’ SELECT * FROM auth_user WHERE username = 'person_123'
    â†’ Topilmadi â†’ Yangi user yaratiladi
    â†’ INSERT INTO auth_user (username='person_123', ...)

Step 3: Login (session yaratish)
    â†’ Django session'ga user_id=456 yoziladi
    â†’ Cookie'ga session_id yoziladi

Step 4: LoginLog yaratish
    â†’ INSERT INTO emotion_app_loginlog (person_id=123, login_method='face', ...)
    â†’ Rasm saqlandi: /media/login_photos/2025/12/19/123_20251219_143022.jpg

### 3. RESPONSE:

HTTP/1.1 200 OK
Content-Type: application/json

{
    "success": true,
    "message": "Testbek Testov tizimga kirdi",
    "redirect_url": "/dashboard/",
    "user": {
        "id": 456,
        "username": "person_123",
        "full_name": "Testbek Testov",
        "is_staff": true,
        "is_superuser": true
    }
}

### 4. FRONTENDDA:

- success: true â†’ Dashboard'ga yo'naltirish
- Cookie'da session_id saqlangan
- Keyingi requestlarda user avtomatik autentifikatsiya qilinadi


================================================================================
                    2. PASSPORT_LOGIN_AUTH - Passport orqali login
================================================================================

### API ENDPOINT:
    POST /api/passport-login-auth/

### MAQSAD:
    Passport seriya + raqam + tug'ilgan sana orqali tizimga kirish

### ISHLASH KETMA-KETLIGI:
    1. Frontend username (AD1234567) va birth_date yuboradi
    2. Backend username'ni parse qiladi (AD + 1234567)
    3. Backend Person'ni topadi (passport_series, passport_number, birth_date)
    4. Backend User yaratadi va loginlaydi


================================================================================
                    PASSPORT_LOGIN_AUTH - INPUT (QABUL QILADI)
================================================================================

### HTTP METOD:
    POST

### CONTENT-TYPE:
    application/json

### REQUEST BODY (JSON):

{
    "username": "AD1234567",                   // MAJBURIY - Passport (seriya + raqam)
    "birth_date": "1990-01-15",                // MAJBURIY - Tug'ilgan sana
    "image": "data:image/jpeg;base64,/9j/..."  // IXTIYORIY - Login vaqtidagi rasm
}

### MAYDONLAR TUSHUNCHASI:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Maydon nomi     â”‚ Majburiy â”‚ Tavsif                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ username        â”‚ âœ… HA    â”‚ Passport: 2 harf + 7 raqam (AD1234567)         â”‚
â”‚ birth_date      â”‚ âœ… HA    â”‚ Tug'ilgan sana (YYYY-MM-DD yoki DD.MM.YYYY)    â”‚
â”‚ image           â”‚ âŒ YO'Q  â”‚ Login vaqtidagi rasm (base64)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

### USERNAME FORMATI:

    Qabul qilinadigan format:
    - 2 ta KATTA harf (A-Z)
    - 7 ta raqam (0-9)

    Misol:
    âœ… AD1234567
    âœ… AB2222222
    âœ… AC3333333

    âŒ ad1234567  (kichik harf - avtomatik KATTA harfga aylantiriladi)
    âŒ A1234567   (faqat 1 ta harf)
    âŒ ABC123456  (3 ta harf)
    âŒ AD12345    (kam raqam)

### BIRTH_DATE FORMATI:

    Qabul qilinadigan formatlar:
    âœ… 1990-01-15      (YYYY-MM-DD)
    âœ… 15.01.1990      (DD.MM.YYYY)
    âœ… 15/01/1990      (DD/MM/YYYY)


================================================================================
                    PASSPORT_LOGIN_AUTH - DATABASE AMALLAR
================================================================================

### 1. USERNAME PARSE QILISH:

    Input:    "AD1234567"

    Regex:    ^([A-Z]{2})(\d{7})$

    Result:
        passport_series = "AD"       # Birinchi 2 ta harf
        passport_number = "1234567"  # Keyingi 7 ta raqam

### 2. BIRTH_DATE PARSE QILISH:

    Input:    "1990-01-15"  yoki  "15.01.1990"

    Formatlar:
    1. %Y-%m-%d    â†’ 1990-01-15
    2. %d.%m.%Y    â†’ 15.01.1990
    3. %d/%m/%Y    â†’ 15/01/1990

    Result:
        birth_date = date(1990, 1, 15)

### 3. PERSON TOPISH:

    SELECT * FROM emotion_app_person
    WHERE passport_series = 'AD'
      AND passport_number = '1234567'
      AND birth_date = '1990-01-15'

    Natija:
    - âœ… Topildi   â†’ Davom etadi
    - âŒ Topilmadi â†’ ERROR 404 (Passport yoki sana noto'g'ri)

### 4. DJANGO USER YARATISH/YANGILASH:

    USERNAME = f"{passport_series}{passport_number}"  # AD1234567

    # User topish yoki yaratish
    SELECT * FROM auth_user WHERE username = 'AD1234567'

    Agar topilmasa:
        INSERT INTO auth_user (
            username,
            first_name,
            last_name,
            is_staff,
            is_superuser,
            is_active
        ) VALUES (
            'AD1234567',
            '{person.first_name}',
            '{person.last_name}',
            TRUE,
            TRUE,
            TRUE
        )

    Agar topilsa:
        UPDATE auth_user
        SET is_staff = TRUE,
            is_superuser = TRUE,
            is_active = TRUE
        WHERE username = 'AD1234567'

### 5. SESSION YARATISH (LOGIN):

    Django'ning login() funksiyasi:
    - User'ni session'ga saqlaydi
    - Cookie'da session_id yaratadi
    - request.user ga tayinlaydi


================================================================================
                    PASSPORT_LOGIN_AUTH - OUTPUT (QAYTARADI)
================================================================================

### MUVAFFAQIYATLI (SUCCESS):

HTTP Status: 200 OK

{
    "success": true,
    "message": "Testbek Testov tizimga kirdi",
    "user": {
        "id": 456,                              // Django User ID
        "username": "AD1234567",                // Passport (seriya + raqam)
        "full_name": "Testov Testbek"           // To'liq ism
    }
}

### XATOLIK - Username formati noto'g'ri:

HTTP Status: 400 Bad Request

{
    "success": false,
    "error": "Username formati noto'g'ri. Masalan: AD2423695"
}

### XATOLIK - Sana formati noto'g'ri:

HTTP Status: 400 Bad Request

{
    "success": false,
    "error": "Sana formati noto'g'ri. Masalan: 2001-12-31"
}

### XATOLIK - Person topilmadi:

HTTP Status: 404 Not Found

{
    "success": false,
    "error": "Passport yoki tug'ilgan sana noto'g'ri"
}

### XATOLIK - Username yoki birth_date yo'q:

HTTP Status: 400 Bad Request

{
    "success": false,
    "error": "Username va tug'ilgan sana kerak"
}

### XATOLIK - Server ichki xato:

HTTP Status: 500 Internal Server Error

{
    "success": false,
    "error": "Xatolik matni..."
}


================================================================================
                    PASSPORT_LOGIN_AUTH - MISOL (TO'LIQ)
================================================================================

### 1. FRONTENDDAN REQUEST:

POST http://localhost:8000/api/passport-login-auth/
Content-Type: application/json

{
    "username": "AD1234567",
    "birth_date": "1990-01-15"
}

### 2. BACKEND JARAYONI:

Step 1: Username parse qilish
    â†’ Input: "AD1234567"
    â†’ Regex: ^([A-Z]{2})(\d{7})$
    â†’ passport_series = "AD"
    â†’ passport_number = "1234567"

Step 2: Birth date parse qilish
    â†’ Input: "1990-01-15"
    â†’ Format: %Y-%m-%d
    â†’ birth_date = date(1990, 1, 15)

Step 3: Person topish
    â†’ SELECT * FROM emotion_app_person
      WHERE passport_series = 'AD'
        AND passport_number = '1234567'
        AND birth_date = '1990-01-15'
    â†’ Person: ID=123, Ism=Testbek, Familiya=Testov

Step 4: Django User yaratish
    â†’ SELECT * FROM auth_user WHERE username = 'AD1234567'
    â†’ Topilmadi â†’ Yangi user yaratiladi
    â†’ INSERT INTO auth_user (username='AD1234567', ...)

Step 5: Login (session yaratish)
    â†’ Django session'ga user_id=456 yoziladi
    â†’ Cookie'ga session_id yoziladi

### 3. RESPONSE:

HTTP/1.1 200 OK
Content-Type: application/json

{
    "success": true,
    "message": "Testbek Testov tizimga kirdi",
    "user": {
        "id": 456,
        "username": "AD1234567",
        "full_name": "Testov Testbek"
    }
}

### 4. FRONTENDDA:

- success: true â†’ Dashboard'ga yo'naltirish
- Cookie'da session_id saqlangan
- Keyingi requestlarda user avtomatik autentifikatsiya qilinadi


================================================================================
                    3. FARQLAR - FACE vs PASSPORT LOGIN
================================================================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Xususiyat               â”‚ face_login_auth  â”‚ passport_login_auth          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Kiritilishi kerak       â”‚ person_id        â”‚ username + birth_date        â”‚
â”‚ Username formati        â”‚ person_{id}      â”‚ {series}{number}             â”‚
â”‚ Avval chaqiriladi       â”‚ detect_face API  â”‚ Yo'q (to'g'ridan-to'g'ri)    â”‚
â”‚ Face recognition        â”‚ âœ… HA            â”‚ âŒ YO'Q                      â”‚
â”‚ LoginLog yaratiladi     â”‚ âœ… HA            â”‚ âŒ YO'Q (kodda yo'q)         â”‚
â”‚ Login rasm saqlanadi    â”‚ âœ… HA            â”‚ âŒ YO'Q                      â”‚
â”‚ Confidence qaytaradi    â”‚ âœ… HA            â”‚ âŒ YO'Q                      â”‚
â”‚ redirect_url qaytaradi  â”‚ âœ… HA            â”‚ âŒ YO'Q                      â”‚
â”‚ Password tekshiriladi   â”‚ âŒ YO'Q          â”‚ âŒ YO'Q (faqat birth_date)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
                    4. JAVASCRIPT MISOLLARI
================================================================================

### A) FACE LOGIN (2 bosqichli):

// 1. Yuzni tanish
const detectResponse = await fetch('/api/detect-face/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        image: webcamBase64Image
    })
});

const detectData = await detectResponse.json();

if (detectData.person && detectData.person.is_registered) {
    // 2. Login qilish
    const loginResponse = await fetch('/api/face-login-auth/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            person_id: detectData.person.id,
            image: webcamBase64Image,
            confidence: detectData.person.confidence
        })
    });

    const loginData = await loginResponse.json();

    if (loginData.success) {
        // Dashboard'ga yo'naltirish
        window.location.href = loginData.redirect_url;
    }
}

### B) PASSPORT LOGIN (1 bosqichli):

const response = await fetch('/api/passport-login-auth/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        username: 'AD1234567',
        birth_date: '1990-01-15'
    })
});

const data = await response.json();

if (data.success) {
    // Dashboard'ga yo'naltirish
    window.location.href = '/dashboard/';
}


================================================================================
                    5. CURL MISOLLARI (TESTING UCHUN)
================================================================================

### A) FACE LOGIN AUTH:

curl -X POST http://localhost:8000/api/face-login-auth/ \
  -H "Content-Type: application/json" \
  -d '{
    "person_id": 123,
    "confidence": 95.67
  }'

### B) PASSPORT LOGIN AUTH:

curl -X POST http://localhost:8000/api/passport-login-auth/ \
  -H "Content-Type: application/json" \
  -d '{
    "username": "AD1234567",
    "birth_date": "1990-01-15"
  }'


================================================================================
                    6. PYTHON REQUESTS MISOLLARI
================================================================================

### A) FACE LOGIN AUTH:

import requests

response = requests.post(
    'http://localhost:8000/api/face-login-auth/',
    json={
        'person_id': 123,
        'confidence': 95.67
    }
)

data = response.json()
print(data)
# {'success': True, 'message': 'Testbek Testov tizimga kirdi', ...}

### B) PASSPORT LOGIN AUTH:

import requests

response = requests.post(
    'http://localhost:8000/api/passport-login-auth/',
    json={
        'username': 'AD1234567',
        'birth_date': '1990-01-15'
    }
)

data = response.json()
print(data)
# {'success': True, 'message': 'Testbek Testov tizimga kirdi', ...}


================================================================================
                    7. XATOLAR VA YECHIMLAR
================================================================================

### XATO 1: "person_id kerak"
SABAB: face_login_auth'ga person_id yuborilmagan
YECHIM: Avval detect_face API'ni chaqiring va person_id'ni oling

### XATO 2: "Shaxs topilmadi" (face_login_auth)
SABAB: Berilgan person_id bazada yo'q
YECHIM: detect_face natijasini tekshiring, person.is_registered = true bo'lishi kerak

### XATO 3: "Username formati noto'g'ri"
SABAB: Username 2 harf + 7 raqam formatida emas
YECHIM: Username = AD1234567 (2 KATTA harf + 7 raqam)

### XATO 4: "Sana formati noto'g'ri"
SABAB: birth_date noto'g'ri formatda
YECHIM: YYYY-MM-DD yoki DD.MM.YYYY formatida yuboring

### XATO 5: "Passport yoki tug'ilgan sana noto'g'ri"
SABAB: Bazada bunday passport+birth_date kombinatsiyasi yo'q
YECHIM: Ma'lumotlarni tekshiring, admin panelda Person mavjudligini tasdiqlang

### XATO 6: CORS Error (frontend'dan)
SABAB: CORS sozlamalari noto'g'ri
YECHIM: settings.py da CORS_ALLOWED_ORIGINS'ni to'g'ri sozlang

### XATO 7: 403 Forbidden (CSRF)
SABAB: CSRF token yo'q
YECHIM: @csrf_exempt dekorator qo'shilgan, headers'da Content-Type: application/json


================================================================================
                    8. SESSION VA COOKIE
================================================================================

### Login'dan keyin:

1. Django session yaratiladi:
   - Backend: django_session jadvalida yozuv
   - Cookie: sessionid={random_hash}

2. Session ma'lumotlari:
   {
       '_auth_user_id': '456',           // User ID
       '_auth_user_backend': 'django.contrib.auth.backends.ModelBackend',
       '_auth_user_hash': '...'
   }

3. Keyingi requestlarda:
   - Browser avtomatik Cookie yuboradi
   - Django session'dan user_id'ni oladi
   - request.user avtomatik to'ldiriladi

4. Logout qilish:
   POST /api/logout/
   - Session o'chiriladi
   - Cookie o'chiriladi


================================================================================
                    9. SECURITY (XAVFSIZLIK)
================================================================================

### âœ… Qilingan xavfsizlik choralari:

1. is_staff = True, is_superuser = True
   â†’ Barcha userlar admin panelga kirishi mumkin

2. Session-based authentication
   â†’ Cookie orqali xavfsiz autentifikatsiya

3. Password hashing
   â†’ Django'ning set_password() funksiyasi (PBKDF2)

4. @csrf_exempt
   â†’ API uchun CSRF check o'chirilgan (JSON API uchun)

### âš ï¸  Potentsial xavfsizliklar:

1. Hamma user superuser
   â†’ Production'da role-based access control qo'shing

2. No rate limiting
   â†’ Brute force hujumlar mumkin (django-ratelimit qo'shing)

3. No password check in passport_login_auth
   â†’ Faqat passport+birth_date yetarli (password tekshirilmaydi)

4. No 2FA
   â†’ Qo'shimcha xavfsizlik uchun 2FA qo'shing


================================================================================
                    10. BEST PRACTICES
================================================================================

1. âœ… Doim error handling qiling
   if (!response.ok) { /* xatolikni ko'rsatish */ }

2. âœ… Loading state ko'rsating
   button.disabled = true; button.textContent = "Yuklanmoqda...";

3. âœ… Validatsiya qiling (frontend)
   - Username: /^[A-Z]{2}\d{7}$/
   - Birth date: YYYY-MM-DD format

4. âœ… Success message ko'rsating
   "Xush kelibsiz, {full_name}!"

5. âœ… Auto redirect qiling
   setTimeout(() => window.location.href = '/dashboard/', 1000);

6. âœ… Session cookie'ni himoya qiling
   - HttpOnly, Secure, SameSite=Strict


================================================================================
                    11. FLOW DIAGRAM
================================================================================

FACE LOGIN FLOW:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. POST /api/detect-face/ + image
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend    â”‚ â†’ Face recognition â†’ Person ID
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 2. Response: { person: { id: 123, ... } }
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 3. POST /api/face-login-auth/ + person_id
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend    â”‚ â†’ Person topish â†’ User yaratish â†’ Login â†’ LoginLog
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 4. Response: { success: true, redirect_url: '/dashboard/' }
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend   â”‚ â†’ window.location.href = '/dashboard/'
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


PASSPORT LOGIN FLOW:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. POST /api/passport-login-auth/ + username + birth_date
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend    â”‚ â†’ Parse â†’ Person topish â†’ User yaratish â†’ Login
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 2. Response: { success: true, user: {...} }
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend   â”‚ â†’ window.location.href = '/dashboard/'
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


================================================================================
                    12. DATABASE TABLES
================================================================================

### Tables ishlatiladi:

1. emotion_app_person
   - id, first_name, last_name, passport_series, passport_number, birth_date

2. auth_user
   - id, username, password, first_name, last_name, is_staff, is_superuser

3. django_session
   - session_key, session_data, expire_date

4. emotion_app_loginlog (faqat face_login_auth)
   - id, person_id, login_method, login_time, ip_address, confidence, login_photo


================================================================================
                    13. TESTING CHECKLIST
================================================================================

### FACE LOGIN AUTH:

â–¡ Valid person_id bilan request
â–¡ Noto'g'ri person_id bilan request (404 error)
â–¡ person_id bo'lmasa (400 error)
â–¡ Image bilan request (LoginLog'da rasm saqlanadi)
â–¡ Confidence bilan request
â–¡ Session yaratilishini tekshirish
â–¡ User admin panelga kirishi mumkinligini tekshirish

### PASSPORT LOGIN AUTH:

â–¡ Valid username + birth_date bilan request
â–¡ Noto'g'ri username format (400 error)
â–¡ Noto'g'ri birth_date format (400 error)
â–¡ Noto'g'ri passport ma'lumotlari (404 error)
â–¡ Username yoki birth_date bo'lmasa (400 error)
â–¡ Session yaratilishini tekshirish
â–¡ User admin panelga kirishi mumkinligini tekshirish


================================================================================
                    XULOSA
================================================================================

1. FACE_LOGIN_AUTH:
   âœ… Person ID orqali login
   âœ… Face recognition bilan ishlaydi
   âœ… LoginLog yaratadi va rasm saqlaydi
   âœ… redirect_url qaytaradi

2. PASSPORT_LOGIN_AUTH:
   âœ… Passport + birth_date orqali login
   âœ… To'g'ridan-to'g'ri (detect_face kerak emas)
   âœ… Password tekshirmasdan loginlaydi
   âœ… LoginLog yaratmaydi

3. IKKALASI HAM:
   âœ… Django User avtomatik yaratadi
   âœ… Session yaratadi (Cookie)
   âœ… is_staff=True, is_superuser=True qiladi
   âœ… JSON API (CSRF exempt)

OMAD! ğŸš€
