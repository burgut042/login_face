================================================================================
                    PASSPORT LOGIN - RASM YANGILASH
================================================================================

ðŸ“… Yaratilgan: 2025-12-19
ðŸŽ¯ Maqsad: Passport login qilganda rasmni yangilash/qo'shish


================================================================================
                    1. ISHLASH JARAYONI
================================================================================

### QADÐÐœ 1: Passport kiritish

User faqat passport seriya+raqamni kiritadi:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Passport (Seriya + Raqam)            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ AD1234567                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                      â”‚
â”‚ [Kirish] tugmasi                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âš ï¸  MUHIM: Tug'ilgan kun KERAK EMAS!


### QADÐÐœ 2: Passport tekshirish

Backend passport bo'yicha Person topadi:

```sql
SELECT * FROM emotion_app_person
WHERE passport_series = 'AD'
  AND passport_number = '1234567'
```

Natija:
âœ… Topildi   â†’ Login muvaffaqiyatli â†’ Photo capture
âŒ Topilmadi â†’ "Passport ma'lumotlari noto'g'ri"


### QADÐÐœ 3: Photo Capture Modal ochiladi

Har doim (eski rasm bor yoki yo'q farqi yo'q):

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ðŸ“¸ Rasmingizni oling                â”‚
â”‚  Login yakunlash uchun rasmingizni oling   â”‚
â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                      â”‚ â”‚
â”‚  â”‚       [Kamera ko'rinishi]            â”‚ â”‚
â”‚  â”‚                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                            â”‚
â”‚  [ðŸ“· Rasm olish]  [â­ï¸ O'tkazib yuborish]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


### QADÐÐœ 4: Rasm olish

User ikki tanlov qilishi mumkin:

1ï¸âƒ£  "Rasm olish" bosadi:
    â†“
    Rasm olinadi va server'ga yuboriladi
    â†“
    CASE 1: Eski rasm BOR edi
        â†’ Eski rasm DISKDAN o'chiriladi
        â†’ Eski rasm DATABASE'dan o'chiriladi
        â†’ Eski face encoding o'chiriladi
        â†’ Yangi rasm saqlanadi
        â†’ Yangi face encoding yaratiladi

    CASE 2: Eski rasm YO'Q edi
        â†’ Yangi rasm saqlanadi
        â†’ Yangi face encoding yaratiladi

2ï¸âƒ£  "O'tkazib yuborish" bosadi:
    â†“
    To'g'ridan-to'g'ri Dashboard'ga o'tadi


================================================================================
                    2. BACKEND LOGIKA (views.py)
================================================================================

### upload_login_photo() - Line 506-583

```python
@csrf_exempt
def upload_login_photo(request):
    # 1. Person topish
    person = Person.objects.get(id=person_id)

    # 2. ESKI RASMNI O'CHIRISH (agar mavjud bo'lsa)
    if person.photo:
        # Diskdan o'chirish
        if os.path.isfile(person.photo.path):
            os.remove(person.photo.path)
            print("âœ… Eski rasm o'chirildi")

        # Database'dan o'chirish
        person.photo.delete(save=False)

    # 3. ESKI FACE ENCODING'NI O'CHIRISH
    person.face_encoding = None

    # 4. YANGI RASMNI SAQLASH
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    filename = f"person_{person.id}_{timestamp}.jpg"
    person.photo.save(filename, ContentFile(image_bytes), save=True)

    # 5. YANGI FACE ENCODING YARATISH
    image = face_recognition.load_image_file(person.photo.path)
    encodings = face_recognition.face_encodings(image)
    if encodings:
        person.face_encoding = encodings[0].tolist()
        person.save()

    # 6. LOGINLOG'GA SAQLASH
    create_login_log(
        person=person,
        login_method='passport',
        request=request,
        image_data=image_data,
        confidence=None
    )
```


================================================================================
                    3. MISOLLAR
================================================================================

### MISOL 1: Eski rasm BOR

**1. Bazada:**
```
Person ID: 123
passport_series: AD
passport_number: 1234567
photo: faces/person_123_20251201_100000.jpg  â† ESKI RASM
face_encoding: [0.123, -0.456, ...]          â† ESKI ENCODING
```

**2. User passport login qiladi:**
```
AD1234567
```

**3. Photo capture modal ochiladi â†’ User rasm oladi**

**4. Backend'da:**
```
âœ… Eski rasm o'chirildi: /media/faces/person_123_20251201_100000.jpg
âœ… Yangi rasm saqlandi: /media/faces/person_123_20251219_143022.jpg
âœ… Yangi face encoding yaratildi: [0.987, -0.654, ...]
âœ… LoginLog yaratildi
```

**5. Bazada (yangilangandan keyin):**
```
Person ID: 123
passport_series: AD
passport_number: 1234567
photo: faces/person_123_20251219_143022.jpg  â† YANGI RASM
face_encoding: [0.987, -0.654, ...]          â† YANGI ENCODING
```

**6. LoginLog'da:**
```
person_id: 123
login_method: passport
login_photo: login_photos/2025/12/19/123_20251219_143022.jpg
login_time: 2025-12-19 14:30:22
```


### MISOL 2: Eski rasm YO'Q

**1. Bazada:**
```
Person ID: 124
passport_series: AB
passport_number: 2222222
photo: NULL                   â† RASM YO'Q
face_encoding: NULL           â† ENCODING YO'Q
```

**2. User passport login qiladi:**
```
AB2222222
```

**3. Photo capture modal ochiladi â†’ User rasm oladi**

**4. Backend'da:**
```
â„¹ï¸  Eski rasm yo'q, yangi rasm saqlanmoqda...
âœ… Yangi rasm saqlandi: /media/faces/person_124_20251219_143500.jpg
âœ… Face encoding yaratildi: [0.111, -0.222, ...]
âœ… LoginLog yaratildi
```

**5. Bazada (yangilangandan keyin):**
```
Person ID: 124
passport_series: AB
passport_number: 2222222
photo: faces/person_124_20251219_143500.jpg  â† YANGI RASM
face_encoding: [0.111, -0.222, ...]          â† YANGI ENCODING
```


================================================================================
                    4. FAYL TIZIMI
================================================================================

### Eski rasm o'chiriladi:

```
/media/faces/
    â”œâ”€â”€ person_123_20251201_100000.jpg  âŒ O'CHIRILDI
    â””â”€â”€ person_123_20251219_143022.jpg  âœ… YANGI
```

### LoginLog rasmlari:

```
/media/login_photos/
    â””â”€â”€ 2025/
        â””â”€â”€ 12/
            â””â”€â”€ 19/
                â”œâ”€â”€ 123_20251219_143022.jpg  âœ… SAQLANADI
                â”œâ”€â”€ 124_20251219_143500.jpg  âœ… SAQLANADI
                â””â”€â”€ ...
```

âš ï¸  MUHIM:
- Person.photo â†’ Faqat eng oxirgi rasm (eski o'chiriladi)
- LoginLog.login_photo â†’ Barcha login rasmlari saqlanadi


================================================================================
                    5. DATABASE TABLES
================================================================================

### emotion_app_person

| id  | passport_series | passport_number | photo                               | face_encoding        |
|-----|-----------------|-----------------|-------------------------------------|----------------------|
| 123 | AD              | 1234567         | faces/person_123_20251219_143022.jpg| [0.987, -0.654, ...] |
| 124 | AB              | 2222222         | faces/person_124_20251219_143500.jpg| [0.111, -0.222, ...] |

â†’ photo: Faqat ENG OXIRGI rasm


### emotion_app_loginlog

| id | person_id | login_method | login_time          | login_photo                                 |
|----|-----------|--------------|---------------------|---------------------------------------------|
| 1  | 123       | passport     | 2025-12-19 14:30:22 | login_photos/2025/12/19/123_20251219_143022.jpg |
| 2  | 124       | passport     | 2025-12-19 14:35:00 | login_photos/2025/12/19/124_20251219_143500.jpg |
| 3  | 123       | passport     | 2025-12-19 15:00:00 | login_photos/2025/12/19/123_20251219_150000.jpg |

â†’ login_photo: BARCHA login rasmlari tarixiy saqlanadi


================================================================================
                    6. API REQUEST/RESPONSE
================================================================================

### POST /api/passport-login/

**Request:**
```json
{
    "username": "AD1234567"
}
```

**Response:**
```json
{
    "success": true,
    "message": "Test User tizimga kirdi",
    "person_id": 123,
    "user": {
        "id": 456,
        "username": "AD1234567",
        "full_name": "Test User"
    },
    "requires_photo": true
}
```


### POST /api/upload-login-photo/

**Request:**
```json
{
    "person_id": 123,
    "image": "data:image/jpeg;base64,/9j/4AAQSkZJRg..."
}
```

**Response:**
```json
{
    "success": true,
    "message": "Rasm muvaffaqiyatli saqlandi",
    "photo_url": "/media/faces/person_123_20251219_143022.jpg"
}
```


================================================================================
                    7. FRONTEND FLOW
================================================================================

### JavaScript (face.html)

```javascript
// 1. Passport login
async function passportLogin(event) {
    const username = document.getElementById('passportUsername').value;

    const response = await fetch('/api/passport-login/', {
        method: 'POST',
        body: JSON.stringify({ username: username })
    });

    const data = await response.json();

    if (data.success) {
        currentPersonId = data.person_id;

        // 2. Photo capture modal ochish
        if (data.requires_photo) {
            openPhotoCaptureModal();
        }
    }
}

// 3. Rasm olish
capturePhotoBtn.addEventListener('click', async () => {
    // Rasmni olish
    const imageData = canvas.toDataURL('image/jpeg', 0.8);

    // Server'ga yuborish
    const response = await fetch('/api/upload-login-photo/', {
        method: 'POST',
        body: JSON.stringify({
            person_id: currentPersonId,
            image: imageData
        })
    });

    const data = await response.json();

    if (data.success) {
        // Dashboard'ga o'tish
        window.location.href = '/dashboard/';
    }
});

// 4. O'tkazib yuborish
skipPhotoBtn.addEventListener('click', () => {
    window.location.href = '/dashboard/';
});
```


================================================================================
                    8. XAVFSIZLIK
================================================================================

### âœ… Xavfsizlik choralari:

1. **Passport validatsiya:**
   - Faqat 2 harf + 7 raqam (AD1234567)
   - Uppercase'ga aylantirish

2. **Rasm formati:**
   - Faqat JPEG (quality=0.8)
   - Base64 validation

3. **Fayl hajmi:**
   - Browser tomonidan limitlangan
   - Server tomonida qo'shimcha limit qo'shish mumkin

4. **Eski rasm o'chirish:**
   - Disk bo'sh joyini tejash
   - Xavfsizlik (eski rasmlarni saqlamas)


================================================================================
                    9. TROUBLESHOOTING
================================================================================

### MUAMMO 1: "Eski rasm o'chirilmadi"
SABAB: Fayl sistemaga ruxsat yo'q
YECHIM:
```bash
chmod 755 /media/faces/
chown www-data:www-data /media/faces/
```

### MUAMMO 2: "Face encoding yaratilmadi"
SABAB: Rasmda yuz topilmadi
YECHIM: User'ga yaxshi yoritilgan joy tavsiya qiling

### MUAMMO 3: "LoginLog rasm saqlanmadi"
SABAB: login_photos papkasi yo'q
YECHIM:
```bash
mkdir -p /media/login_photos/
chmod 755 /media/login_photos/
```


================================================================================
                    10. TESTING
================================================================================

### Test 1: Eski rasm bilan

1. Bazada rasm bor Person yarating:
   - passport_series: AD
   - passport_number: 1111111
   - photo: faces/old_photo.jpg

2. Login qiling: AD1111111

3. Rasm oling

4. Tekshiring:
   âœ… Eski rasm o'chirilganmi? (faces/old_photo.jpg)
   âœ… Yangi rasm saqlanganmi?
   âœ… Face encoding yangilanganmi?
   âœ… LoginLog yaratilganmi?


### Test 2: Rasmsiz Person

1. Bazada rasmsiz Person yarating:
   - passport_series: AB
   - passport_number: 2222222
   - photo: NULL

2. Login qiling: AB2222222

3. Rasm oling

4. Tekshiring:
   âœ… Yangi rasm saqlanganmi?
   âœ… Face encoding yaratilganmi?
   âœ… LoginLog yaratilganmi?


### Test 3: O'tkazib yuborish

1. Login qiling: AD1111111

2. "O'tkazib yuborish" bosing

3. Tekshiring:
   âœ… Dashboard'ga o'tilganmi?
   âœ… Rasm saqlanmadimi?


================================================================================
                    XULOSA
================================================================================

âœ… Passport login faqat passport seriya+raqam bilan ishlaydi
âœ… Har doim photo capture modal ochiladi
âœ… Eski rasm o'chiriladi (disk va database)
âœ… Eski face encoding o'chiriladi
âœ… Yangi rasm Person'ga saqlanadi
âœ… Yangi face encoding yaratiladi
âœ… LoginLog'ga ham rasm saqlanadi
âœ… User o'tkazib yuborishi mumkin

TAYYOR! ðŸŽ‰
